name: iOS TestFlight

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.swift"
      - "**/*.xcodeproj"
      - "**/*.xcworkspace"
      - "fastlane/**"
      - ".github/workflows/ios-testflight.yml"
      - "Gemfile*"

jobs:
  build-upload:
    runs-on: macos-latest
    env:
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_API_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}
      IOS_SCHEME: SkyFeederFieldUtility
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Detect scheme
        run: |
          set -eo pipefail
          DEFAULT_SCHEME="${IOS_SCHEME:-SkyFeederFieldUtility}"

          WORKSPACE=$(ls -d ./*.xcworkspace 2>/dev/null | head -n 1)
          if [ -z "$WORKSPACE" ]; then
            WORKSPACE=$(find . -name "*.xcworkspace" -print | head -n 1)
          fi

          PROJECT=$(ls -d ./*.xcodeproj 2>/dev/null | head -n 1)
          if [ -z "$PROJECT" ]; then
            PROJECT=$(find . -name "*.xcodeproj" -print | head -n 1)
          fi

          if [ -n "$WORKSPACE" ]; then
            echo "Using workspace $WORKSPACE for scheme detection."
            SCHEME_JSON=$(xcodebuild -workspace "$WORKSPACE" -list -json)
          elif [ -n "$PROJECT" ]; then
            echo "Using project $PROJECT for scheme detection."
            SCHEME_JSON=$(xcodebuild -project "$PROJECT" -list -json)
          else
            echo "No workspace or project found for scheme detection." >&2
            exit 1
          fi

          DETECTED="$(printf "%s" "$SCHEME_JSON" | DEFAULT_SCHEME="$DEFAULT_SCHEME" python3 -c 'import json, os, sys; data=json.load(sys.stdin); schemes=data.get("workspace", {}).get("schemes") or data.get("project", {}).get("schemes") or []; default=os.environ.get("DEFAULT_SCHEME") or ""; print(default if default and default in schemes else (schemes[0] if schemes else default))')"

          if [ -z "$DETECTED" ]; then
            DETECTED="$DEFAULT_SCHEME"
          fi

          if [ "$DETECTED" != "$DEFAULT_SCHEME" ]; then
            echo "Detected scheme: $DETECTED (default was $DEFAULT_SCHEME)"
          else
            echo "Using scheme: $DETECTED"
          fi

          echo "IOS_SCHEME=$DETECTED" >> "$GITHUB_ENV"

      - name: Install fastlane
        run: bundle install --path vendor/bundle

      - name: Build & Upload to TestFlight
        run: bundle exec fastlane testflight_upload

      - name: Publish build summary
        if: success()
        run: |
          if [ -f build/build_info.json ]; then
            SUMMARY="$(python3 -c 'import json, pathlib; info=json.loads(pathlib.Path("build/build_info.json").read_text()); print("### TestFlight Upload"); print(f"- Version: {info.get(\"version\", \"n/a\")}"); print(f"- Build: {info.get(\"build_number\", \"n/a\")}"); print(f"- [View in App Store Connect]({info.get(\"app_store_connect_link\", \"https://appstoreconnect.apple.com/apps\")})")')"
            if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
              printf "%s\n" "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "No build/build_info.json generated; skipping summary export."
          fi
