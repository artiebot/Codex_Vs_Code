name: iOS TestFlight

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.swift"
      - "**/*.xcodeproj"
      - "**/*.xcworkspace"
      - "fastlane/**"
      - ".github/workflows/ios-testflight.yml"
      - "Gemfile*"

jobs:
  build-upload:
    runs-on: macos-latest
    env:
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_API_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}
      TEAM_ID: ${{ secrets.TEAM_ID }}
      MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      IOS_SCHEME: SkyFeederFieldUtility
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Install XcodeGen
        run: brew install xcodegen || true

      - name: Generate Xcode project
        working-directory: mobile/ios-field-utility
        run: |
          xcodegen generate
          xcodebuild -resolvePackageDependencies -project SkyFeederFieldUtility.xcodeproj

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install fastlane
        run: bundle install --path vendor/bundle

      - name: Debug - show URL and header length (safe)
        run: |
          echo "URL: $MATCH_GIT_URL"
          echo "Auth header length: ${#MATCH_GIT_BASIC_AUTHORIZATION}"

      - name: Pull signing (match)
        working-directory: mobile/ios-field-utility
        env:
          BUNDLE_GEMFILE: ../../Gemfile
        run: |
          bundle exec fastlane run match \
            git_url:$MATCH_GIT_URL \
            type:appstore \
            readonly:true \
            app_identifier:com.skyfeeder.field

      - name: Build & Upload to TestFlight
        working-directory: mobile/ios-field-utility
        env:
          BUNDLE_GEMFILE: ../../Gemfile
        run: bundle exec fastlane testflight_upload

      - name: Publish build summary
        if: success()
        run: |
          if [ -f mobile/ios-field-utility/build/build_info.json ]; then
            SUMMARY="$(python3 -c 'import json, pathlib; info=json.loads(pathlib.Path("mobile/ios-field-utility/build/build_info.json").read_text()); print("### TestFlight Upload"); print(f"- Version: {info.get(\"version\", \"n/a\")}"); print(f"- Build: {info.get(\"build_number\", \"n/a\")}"); print(f"- [View in App Store Connect]({info.get(\"app_store_connect_link\", \"https://appstoreconnect.apple.com/apps\")})")')"
            if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
              printf "%s\n" "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "No build/build_info.json generated; skipping summary export."
          fi
