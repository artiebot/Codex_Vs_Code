require "base64"
require "shellwords"

default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :testflight_upload do
    project_path = Dir["../*.xcodeproj"].first
    UI.user_error!("No Xcode project found") if project_path.nil?
    project_path = File.expand_path(project_path)

    scheme_name = ENV["IOS_SCHEME"] || "SkyFeederFieldUtility"
    api_key = resolve_api_key
    bundle_id = ENV["PRODUCT_BUNDLE_IDENTIFIER"] || "com.skyfeeder.field"
    team_id = ENV["TEAM_ID"]
    UI.user_error!("TEAM_ID is required") if team_id.to_s.empty?

    keychain_name = ENV["MATCH_KEYCHAIN_NAME"]
    keychain_password = ENV["MATCH_KEYCHAIN_PASSWORD"] || ENV["KEYCHAIN_PASSWORD"] || ""
    if keychain_name.to_s.empty?
      keychain_name = ENV["CI"] == "true" ? "build.keychain" : "login.keychain"
    end

    match_params = {
      type: "appstore",
      readonly: true,
      api_key: api_key,
      app_identifier: bundle_id
    }
    match_params[:git_url] = ENV["MATCH_GIT_URL"] if ENV["MATCH_GIT_URL"]
    match_params[:git_basic_authorization] = ENV["MATCH_GIT_BASIC_AUTHORIZATION"] if ENV["MATCH_GIT_BASIC_AUTHORIZATION"]
    if keychain_name
      match_params[:keychain_name] = keychain_name
      match_params[:keychain_password] = keychain_password
      if keychain_password.to_s.length.positive?
        sh("security set-key-partition-list -S apple-tool:,apple: -s -k #{Shellwords.escape(keychain_password)} #{Shellwords.escape(keychain_name)}")
      end
    end

    match(match_params)

    profile_specifier = ENV["APP_PROVISIONING_PROFILE_SPECIFIER"] || ENV["SIGH_#{bundle_id.gsub('.', '_')}_PROFILE_NAME"] || "match AppStore #{bundle_id}"

    xcargs = [
      "CODE_SIGN_STYLE=Manual",
      "CODE_SIGN_IDENTITY='Apple Distribution'",
      "DEVELOPMENT_TEAM=#{team_id}",
      "PROVISIONING_PROFILE_SPECIFIER='#{profile_specifier}'",
      "PRODUCT_BUNDLE_IDENTIFIER=#{bundle_id}",
      "APP_BUNDLE_IDENTIFIER=#{bundle_id}",
      "APP_DEVELOPMENT_TEAM=#{team_id}",
      "APP_PROVISIONING_PROFILE_SPECIFIER='#{profile_specifier}'",
      "APP_CODE_SIGN_STYLE=Manual",
      "-showBuildTimingSummary"
    ].join(" ")

    gym(
      project: project_path,
      scheme: scheme_name,
      configuration: "Release",
      export_method: "app-store",
      export_team_id: team_id,
      output_directory: "../build",
      output_name: "SkyFeederFieldUtility.ipa",
      clean: true,
      xcargs: xcargs,
      export_options: {
        method: "app-store",
        teamID: team_id,
        provisioningProfiles: {
          bundle_id => profile_specifier
        }
      }
    )

    build = pilot(
      api_key: api_key,
      ipa: "../build/SkyFeederFieldUtility.ipa",
      skip_submission: true,
      skip_waiting_for_build_processing: false,
      distribute_external: true
    )

    if build
      version = build.respond_to?(:app_version) ? build.app_version : nil
      build_number = build.respond_to?(:build_version) ? build.build_version : nil
      apple_id = build.respond_to?(:apple_id) ? build.apple_id : nil
      link = apple_id ? "https://appstoreconnect.apple.com/apps/#{apple_id}/testflight/ios" : "https://appstoreconnect.apple.com/apps"

      require "json"
      require "fileutils"
      FileUtils.mkdir_p("../build")
      build_info = {
        version: version,
        build_number: build_number,
        app_store_connect_link: link
      }.compact
      File.write(File.join("../build", "build_info.json"), JSON.pretty_generate(build_info))

      if (summary_path = ENV["GITHUB_STEP_SUMMARY"]).to_s.strip.length > 0
        File.open(summary_path, "a") do |file|
          file.puts("### TestFlight Upload")
          file.puts("- Version: #{version || 'n/a'}")
          file.puts("- Build: #{build_number || 'n/a'}")
          file.puts("- [View in App Store Connect](#{link})")
        end
      end
    end
  end
end

def resolve_api_key
  issuer = ENV["ASC_ISSUER_ID"]
  key_id = ENV["ASC_KEY_ID"]
  raw_key = ENV["ASC_API_KEY_P8"]

  UI.user_error!("ASC_ISSUER_ID is required") if issuer.to_s.empty?
  UI.user_error!("ASC_KEY_ID is required") if key_id.to_s.empty?
  UI.user_error!("ASC_API_KEY_P8 is required") if raw_key.to_s.empty?

  if File.exist?(raw_key)
    app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer,
      key_filepath: raw_key
    )
  else
    decoded = raw_key.include?("-----BEGIN") ? raw_key : Base64.decode64(raw_key)
    app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer,
      key_content: decoded
    )
  end
end

def is_ci
  # Check if running in a CI environment
  ENV["CI"] == "true" ||
    ENV["GITHUB_ACTIONS"] == "true" ||
    ENV["JENKINS_HOME"] ||
    ENV["CIRCLECI"] == "true" ||
    ENV["GITLAB_CI"] == "true"
end

def setup_code_signing(bundle_id:, readonly:, api_key:)
  match_git_url = ENV["MATCH_GIT_URL"]
  match_password = ENV["MATCH_PASSWORD"]

  UI.user_error!("MATCH_GIT_URL is required") if match_git_url.to_s.empty?
  UI.user_error!("MATCH_PASSWORD is required") if match_password.to_s.empty?

  match(
    type: "appstore",
    app_identifier: bundle_id,
    git_url: match_git_url,
    readonly: readonly,
    api_key: api_key
  )
end
