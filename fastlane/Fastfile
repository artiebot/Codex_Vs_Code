require "base64"
require "json"
require "fileutils"

APP_SCHEME  = "SkyFeederFieldUtility".freeze
APP_PROJECT = "mobile/ios-field-utility/SkyFeederFieldUtility.xcodeproj".freeze

default_platform(:ios)

platform :ios do
  desc "Build & Upload to TestFlight"
  lane :testflight_upload do
    setup_ci

    api_key = resolve_api_key

    keychain_name = ENV["MATCH_KEYCHAIN_NAME"] || (ENV["CI"] ? "build.keychain" : nil)
    keychain_password = ENV["KEYCHAIN_PASSWORD"] || ""

    match_params = {
      type: "appstore",
      readonly: true,
      api_key: api_key
    }
    match_params[:git_url] = ENV["MATCH_GIT_URL"] if ENV["MATCH_GIT_URL"]
    match_params[:git_basic_authorization] = ENV["MATCH_GIT_BASIC_AUTHORIZATION"] if ENV["MATCH_GIT_BASIC_AUTHORIZATION"]
    if keychain_name
      match_params[:keychain_name] = keychain_name
      match_params[:keychain_password] = keychain_password
    end

    match(match_params)

    build_app(
      project: APP_PROJECT,
      scheme: APP_SCHEME,
      export_method: "app-store",
      xcargs: "-showBuildTimingSummary",
      output_directory: "build",
      output_name: "SkyFeederFieldUtility.ipa"
    )

    uploaded_build = upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )

    write_build_summary(uploaded_build) if uploaded_build
  end
end

def resolve_api_key
  issuer = ENV["ASC_ISSUER_ID"]
  key_id = ENV["ASC_KEY_ID"]
  raw_key = ENV["ASC_API_KEY_P8"]

  UI.user_error!("ASC_ISSUER_ID is required") if issuer.to_s.empty?
  UI.user_error!("ASC_KEY_ID is required") if key_id.to_s.empty?
  UI.user_error!("ASC_API_KEY_P8 is required") if raw_key.to_s.empty?

  if File.exist?(raw_key)
    app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer,
      key_filepath: raw_key
    )
  else
    decoded = raw_key.include?("-----BEGIN") ? raw_key : Base64.decode64(raw_key)
    app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer,
      key_content: decoded
    )
  end
end

def write_build_summary(build)
  version = build.respond_to?(:app_version) ? build.app_version : nil
  build_number = build.respond_to?(:build_version) ? build.build_version : nil
  apple_id = build.respond_to?(:apple_id) ? build.apple_id : nil
  link = apple_id ? "https://appstoreconnect.apple.com/apps/#{apple_id}/testflight/ios" : "https://appstoreconnect.apple.com/apps"

  FileUtils.mkdir_p("build")
  info = {
    version: version,
    build_number: build_number,
    app_store_connect_link: link
  }.compact
  File.write(File.join("build", "build_info.json"), JSON.pretty_generate(info))

  if (summary_path = ENV["GITHUB_STEP_SUMMARY"]).to_s.strip.length.positive?
    File.open(summary_path, "a") do |file|
      file.puts("### TestFlight Upload")
      file.puts("- Version: #{version || 'n/a'}")
      file.puts("- Build: #{build_number || 'n/a'}")
      file.puts("- [View in App Store Connect](#{link})")
    end
  end
end
